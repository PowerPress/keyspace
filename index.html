<html>
<head>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="colourPinLists.json"></script>
<script src="commonKeyDepths.json"></script>
<script src="rules.js"></script>
<script src="analysis_supp.js"></script>
<script src="Lockview/lockview.js"></script>
<script src="Lockview/svg.min.js"></script>

<script>

var space=[];
var pspace=true;
var a_space=[];
var a_pspace=true;

var selected_code;
var a_selected_code;

var io_depths=[];
var io_angles=[];

var cache={};

var halfSpace = false;

rules=[];

function recalcSpace() {
	var i;
	a_space=Array();
	fa_space=Array();
	
	numPins=parseInt(document.getElementById("numPins").value);
	numDepths=parseInt(document.getElementById("numDepths").value);
	labelOffset=parseInt(document.getElementById("pinLabels").selectedIndex);
	numAngles=0;
	
	var pins="";
	var fa="";
	var mmacs="";
	var udPins="";
	var filea="<table><tr><td colspan='2'>Depth:</td>";
	var newLockType=lockType!=document.getElementById('lockType').value && document.getElementById("filea_0_0");
	lockType=document.getElementById('lockType').value;
	
	var angle_map=[];
	if(lockType=="medeco") {angle_map=["L","C","R"]; numAngles=3;}
	if(lockType=="medeco2") {angle_map=["L_","C_","R_","LL","LC","LR","L_","CL","CC","CR","C_","RL","RC","RR","R_"]; numAngles=15;}
	
	for(i=0;i<numPins;i++) {
		pins+="<span class='tupin'>Pin</span> "+(i+1)+":<input id='shear"+i+"' class='form-control' style='width:65px;display:inline-block' /> ";
		udPins+="<div style='display:inline-block;border:1px solid #CCCCCC;margin:4px;padding:10px;border-radius:10px;background-color:#DDDDDD;'><span class='tupin'>Pin</span> "+(i+1)+":<br/>&ge;<input type='number' min=0 max='"+numDepths+"' value=1 id='udPin"+i+"d' class='form-control' style='width:60px;display:inline-block' /> <br/>&le;<input type='number' min=1 max='"+numDepths+"' value='"+numDepths+"' id='udPin"+i+"u' class='form-control' style='width:60px;display:inline-block' /></div>";
		fa+="<span class='tupin'>Pin</span> "+(i+1)+":<select id='FA"+i+"' class='form-control' style='width:auto;display:inline-block'><option value='F'>F</option><option value='A'>A</option><option value='?'>?</option></select>";
		if(i<numPins-1)
			mmacs+="<span class='tupin'>Pin</span>s "+(i+1)+"-"+(i+2)+":<input type='number' min=1 max=11 value=3 id='medMACS"+i+"' class='form-control' style='width:60px;display:inline-block' /> ";
		fa_space.push("?");
	}
	
	for(i=0;i<numDepths;i++) {
		filea+="<td>"+(parseInt(i)+labelOffset)+" </td>";
	}
	filea+="</tr><tr><td rowspan="+numDepths+" style='width:1em;'><span style='transform: rotate(-90deg);float:left;transform-origin: 22px 22px 0;white-space: nowrap;width:1em;'>can file to</span></td>";
	for(i=0;i<numDepths;i++) {
		filea+=(i==0?"":"<tr>")+"<td>"+(parseInt(i)+labelOffset)+" </td>";
		for(j=0;j<numDepths;j++) {
			filea+="<td>"
			if(i!=j)
				filea+="<input type='checkbox' id='filea_"+i+"_"+j+"' "+(newLockType?document.getElementById("filea_"+i+"_"+j).checked:((i>j||lockType=="evva")&&lockType!="wafer"?" checked":""))+" />"
			filea+="</td>";
		}
	}
	filea+="</table>";
	
	shearDiv.innerHTML=pins;
	FADiv.innerHTML=fa;
	medMACSDiv.innerHTML=mmacs;
	photoPinDiv.innerHTML=udPins;
	fileability.innerHTML=filea;
	
	colouredPinDiv.innerHTML="Coloured pins are visible with otoscope; system: <select id='colourPinKeySys' class='form-control' style='width:auto;display:inline-block'>"+commonKeyDepthsOpts()+"</select>"
		+"pin set: <select id='colourPinSet' onchange=\"[...Array(numPins).keys()].forEach(i=>document.getElementById('pinColour_'+i).innerHTML=colouredPinColoursOpts(colourPinLists[this.selectedIndex].list));\" onload=\"this.dispatchEvent(document.createEvent('change'))\" class='form-control' style='width:auto;display:inline-block'>"+colouredPinSetOpts()+"<option>Select</option></select><br />"
		+"Colours observed: "
		+[...Array(numPins).keys()].map( 
			i=>
			 "<span class='tupin'>Pin</span> "+(i+1)+":"
			+"<select id='pinColour_"+i+"' class='form-control' style='width:auto;display:inline-block'>"
			+colouredPinColoursOpts(colourPinLists[0].list)
			+"</select>"
		);

	
	if(lockType=="abloy_protec" && !newLockType) {
		filea_1_0.checked=false;
		filea_4_0.checked=false;
		filea_2_1.checked=false;
		filea_3_2.checked=false;
		filea_4_2.checked=false;
		filea_4_3.checked=false;
	}
	
	photoDeltaP1.max=numPins-1;
	photoDeltaP2.max=numPins;
	photoDeltaDd.min=1-numDepths;
	photoDeltaDu.min=1-numDepths;
	photoDeltaDd.max=numDepths-1;
	photoDeltaDu.max=numDepths-1;

	//Handle Angles
	a_space_notif="";
	if(lockType=="medeco") {
		a_space_notif="; Angle Space: "+Math.pow(3,numPins)+"";
		for(j=0;j<numPins;j++) {
			a_space.push(["L","C","R"]);
		}
	} else if(lockType=="medeco2") {
		a_space_notif="; Angle Space: "+Math.pow(6,numPins)+"/"+Math.pow(15,numPins)+"";
		for(j=0;j<numPins;j++) {
			a_space.push(["_L","_C","_R","LL","LC","LR","L_","CL","CC","CR","C_","RL","RC","RR","R_"]);
		}
	}

	list="";
	list+=makeRuleHTML("#99FF00","Starting Keyspace",Math.pow(numDepths,numPins)+a_space_notif,-1);

	space=[];
	cur=Array(numPins).fill(0);
	
	for(i=0;i<numPins;i++) {
		space.push([]);
		for(j=0;j<numDepths;j++) {
			space[i].push(j);
		}
	}
	pspace=true;
	a_pspace=true;
	
	// Check for cache hits
	lockHashData = numPins+","+numDepths+lockType;
	var hit;
	var firstNRules = rules;
	for(i = rules.length-1; i>0; i--) {
		firstNRules = rules.slice(0,i);
		hit = cache[hash(JSON.stringify(firstNRules)+lockHashData)];
		if(hit) {
			break;
			console.log("Cache hit, first "+i+" rules, got ",hit);
		}
	}
	
	if(rules.length>0 && rules[0].name == "codebook") {
		space = codebook_ex.map((u,j)=>Array(8).fill(0).map((v,i)=>parseInt(codebook_ex[j].toString().charAt(i))-1));
		pspace = false;
	}
	
	// Calculate space
	for(ruleNum in rules) {
		ruleNum=parseInt(ruleNum);
		if(rules[0].name !== "codebook" || i>0) {
			rule_s(rules[ruleNum],space);
		}
		rule_html(rules[ruleNum],ruleNum);
	}	
	
	// Save to cache
	cache[hash(JSON.stringify(rules+lockHashData))]={space:space, pspace:pspace, a_space:a_space, a_pspace:a_pspace}
	
	
	pinFreqHTML = freqHTML();
	if(halfSpace) {
		// This is one of the hackiest piles of crap I've dumped out in a long time... this whole damn thing needs a huge refactor 
		unHalvedSpace = space;
		space = halveKeyspace(pspace);
		pinFreqHTML = freqHTML();
		space = unHalvedSpace;
		space = halveKeyspace();
	}
	
	if(pspace && spaceSize(space)<150)
		space=expandDependantKeyspace(space);
	
	halfCheckbox = "";
	if(lockType=="pin" || lockType=="wafer" || lockType=="disc") {
		halfCheckbox = " <label><input type='checkbox'"+(halfSpace?" checked":"")+" onchange='halfSpace=this.checked;recalcSpace();' />Half heights work</label>";
	} else {
		halfSpace = false;
	}
	
	if(spaceSize(space)==0) {
		list+=makeRuleHTML("#99FF00","Entire Keyspace ruled out - this system is not possible.",0,-1);
	} else if(spaceSize(space)==1) {
		list+=makeRuleHTML("#99FF00","Decoded final key: <div class='rule' style='background-color:#FFFF00;display:inline-block;vertical-align:text-top;'>"+stringFromCode(space[0])+"</div>",1,-1);
	} else if(spaceSize(space)<120) {
		var s="Remaining Keyspace:";
		cc_opt="";
		for(i in space) {
			s+="<div class='rule' style='background-color:#FFFF00;display:inline-block;vertical-align:text-top;' onclick='selected_code=space["+i+"];'>"+stringFromCode(space[i])+"</div>";
			cc_opt+="<option value='"+parseInt(space[i].map(function(x) {return x+labelOffset}).join(''))+"'>"+stringFromCode(space[i])+"</option>";
		}
		//medeco_cc_depths.innerHTML=cc_opt;
		//io_depths.innerHTML=cc_opt;
		list+=makeRuleHTML("#99FF00",s+pinFreqHTML,spaceSize(space)+halfCheckbox,-1);
	} else {
		list+=makeRuleHTML("#99FF00","Space <span class='tpin'>pin</span> frequency:"+pinFreqHTML,spaceSize(space)+halfCheckbox,-1);
	}
	
	if(lockType=="medeco" || lockType=="medeco2") {
		a_draw="<div class='rule' style='background-color:#FFFF00;display:inline-block;vertical-align:text-top;'><tt><xmp style='margin:0;'>"+drawAngle(reduceASpace())+"</xmp></tt></div>";
		if(a_pspace && spaceSize(a_space,a_pspace)<150)
			a_space=expandDependantKeyspace(a_space,numAngles);

		if(spaceSize(a_space,a_pspace)==0) {
			list+=makeRuleHTML("#99FF00","Entire angle space ruled out - this system is not possible.",0,-1);
		} else if(spaceSize(a_space,a_pspace)==1) {
			list+=makeRuleHTML("#99FF00","Decoded final angles: <div class='rule' style='background-color:#FFFF00;display:inline-block;vertical-align:text-top;'>"+stringFromCode(undefined,a_space[0])+"</div>"+a_draw,1,-1);
		} else if(spaceSize(a_space,a_pspace)<150) {
			s="Remaining Angle Space:"+a_draw+"<br />";
			cc_opt="";
			for(i in a_space) {
				s+="<div class='rule' style='background-color:#FFFF00;display:inline-block;vertical-align:text-top;'>"+stringFromCode(undefined,a_space[i])+"</div>";
				cc_opt+="<option value='"+stringFromCode(undefined,a_space[i]).replace(/ /g,"")+"'>"+stringFromCode(undefined,a_space[i])+"</option>";
			}
			list+=makeRuleHTML("#99FF00",s,spaceSize(a_space,a_pspace),-1);
			//medeco_cc_angles.innerHTML=cc_opt;
			//io_angles.innerHTML=cc_opt;
		} else {
			list+=makeRuleHTML("#99FF00","Remaining Angle Space:"+a_draw,spaceSize(a_space,a_pspace),-1);
		}
	}

	bruteForceCost = bruteForceCostString(spaceSize(space));
	bruteForceTime = bruteForceTimeString(spaceSize(space));

	startingBits = Math.log2(Math.pow(numDepths,numPins)).toFixed(1);
	endingBits = Math.log2(spaceSize(space)).toFixed(1);
	list += "This keying system normally has <b>" + startingBits + " bits</b> of entropy; these rules reduce it to <b>" + endingBits + " bits of conditional entropy</b>.<br />";
	list += "Brute forcing the entire key space will cost on the order of <b>$" + bruteForceCost + "</b> and take <b>" + bruteForceTime + "</b> to try all keys once cut.<br />";
	
	document.getElementById("spacelist").innerHTML=list;
	//document.getElementById("IO").value='{"numPins":'+numPins+',"numDepths":'+numDepths+',"lockType":"'+lockType+'","rules":'+JSON.stringify(rules)+'}';
	
	nextImprTryout=topCuts(pinFreq());
	document.getElementById('imprTryout').innerHTML='Next tryout: <div class=\'rule\' style=\'background-color:#FFFF00\'>'+stringFromCode(nextImprTryout.map(v=>v-1+labelOffset))+'</div>';
	document.getElementById('imprDepth').value=nextImprTryout[document.getElementById('imprPin').value-1]+labelOffset;
	
	renameTPins();
}
function bruteForceCostString(spaceSize) {
	blankCosts = {"pin":0.26,"wafer":0.55,"medeco":1.5,"medeco2":1.8,"disc":2.4,"abloy_exec":2.4,"abloy_protec":14.0,"multlock":7.0,"evva":15.0};
	bruteForceCost = parseFloat(blankCosts[document.getElementById("lockType").value]) * spaceSize;
	if(bruteForceCost < 10) bruteForceCost = bruteForceCost.toFixed(2);
	else if(bruteForceCost < 1000) bruteForceCost = Math.round(bruteForceCost).toFixed(2);
	else if(bruteForceCost < 1000000) bruteForceCost = Math.round(bruteForceCost / 1000.0).toFixed(0) + "K";
	else if(bruteForceCost < 1000000000) bruteForceCost = Math.round(bruteForceCost / 1000000.0).toFixed(1) + " million";
	else if(bruteForceCost < 1000000000000) bruteForceCost = Math.round(bruteForceCost / 1000000000.0).toFixed(1) + " billion";
	else if(bruteForceCost < 1000000000000000) bruteForceCost = Math.round(bruteForceCost / 1000000000000.0).toFixed(1) + " trillion";
	else if(bruteForceCost < 1000000000000000000) bruteForceCost = Math.round(bruteForceCost / 1000000000000000.0).toFixed(1) + " quadrillion";
	else                                 		  bruteForceCost = Math.round(bruteForceCost / 1000000000000000000.0).toFixed(1) + " quintillion";
	return bruteForceCost;
}
function bruteForceTimeString(spaceSize) {
	bruteForceTime = 6 * spaceSize;
	if(bruteForceTime < 60) bruteForceTime += " seconds";
	else if(bruteForceTime < 3600*1.5) bruteForceTime = (bruteForceTime / 60.0).toFixed(0) + " minutes";
	else if(bruteForceTime < 86400*1.5) bruteForceTime = (bruteForceTime / 3600.0).toFixed(0) + " hours";
	else if(bruteForceTime < 604800*1.5) bruteForceTime = (bruteForceTime / 86400.0).toFixed(0) + " days";
	else if(bruteForceTime < 2592000*1.5) bruteForceTime = (bruteForceTime / 604800.0).toFixed(0) + " weeks";
	else if(bruteForceTime < 31556736*1.5) bruteForceTime = (bruteForceTime / 2592000.0).toFixed(0) + " months";
	else if(bruteForceTime < 31556736000*2.5) bruteForceTime = (bruteForceTime / 31556736.0).toFixed(0) + " years";
	else if(bruteForceTime < 31556736000000) bruteForceTime = (bruteForceTime / 31556736000.0).toFixed(0) + " thousand years";
	else if(bruteForceTime < 31556736000000000) bruteForceTime = (bruteForceTime / 31556736000000.0).toFixed(1) + " million years";
	else if(bruteForceTime < 31556736000000000*13.8) bruteForceTime = (bruteForceTime / 31556736000000000.0).toFixed(1) + " billion years";
	else if(bruteForceTime < 31556736000000000*13800) bruteForceTime = (bruteForceTime / 435482956800000000.0).toFixed(1) + " times the age of the universe";
	else                                 			  bruteForceTime = (bruteForceTime / 435482956800000000000.0).toFixed(1) + " thousand times the age of the universe";
	return bruteForceTime;
}

function renameTPins() {
	if(lockType=="disc" || lockType=="abloy_exec" || lockType=="abloy_protec") {
		$(".tpin").html("disc");
		$(".tupin").html("Disc");
	} else {
		$(".tpin").html("pin");
		$(".tupin").html("Pin");
	}
}

function pinFreq() {
	var numFreqDepths = numDepths;
	if(halfSpace) {
		numFreqDepths = halfHeightsOneStack([...Array(numDepths).keys()]).length;
	}
	if(pspace) {
		c=spaceSize(space);
		f=Array(numPins);
		for(i=0;i<numPins;i++) {
			f[i]=Array.apply(null, Array(numFreqDepths)).map(Number.prototype.valueOf,0)
			if(halfSpace) {
				halfStack = halfHeightsOneStack([...Array(numDepths).keys()]);
				for(j in space[i]) {
					f[i][halfStack.indexOf(space[i][j])]=c/space[i].length;
				}
			} else {
				for(j in space[i]) {
					f[i][space[i][j]]=c/space[i].length;
				}
			}
			for(j in space[i]) {
				f[i][space[i][j]]=c/space[i].length;
			}
		}
		return f;	
		
	} else {
	
		f=Array(numPins);
		for(i=0;i<numPins;i++) {
			f[i]=Array.apply(null, Array(numFreqDepths)).map(Number.prototype.valueOf,0)
		}
		for(i in space) {
			if(halfSpace) {
				halfStack = halfHeightsOneStack([...Array(numDepths).keys()]);
				for(j=0;j<numPins;j++) {
					f[j][halfStack.indexOf(space[i][j])]++;
				}
			} else {
				for(j=0;j<numPins;j++) {
					f[j][space[i][j]]++;
				}
			}
		}
		return f;
	}
}
function topCuts(f) {
	tc=Array(numPins);
	for(i=0;i<numPins;i++) {
		for(tc[i]=0;tc[i]<numDepths;tc[i]++) {
			if(f[i][tc[i]]>0) break;
		}
	}
	return tc;
}
function freqHTML() {
	f=pinFreq();
	max=Math.max(...pinFreq().map(function(x) {return Math.max(...x)})); // Max
	min=Math.min(...pinFreq().map(function(y) {return y.reduce(function(a,x) {return (x>0)?Math.min(a,x):a},10000000000000)})); // Min non-zero
	
	var depthLabels = [...Array(numDepths).keys()].map(v=>v+labelOffset);
	if(halfSpace) {
		depthLabels = halfHeightsOneStack([...Array(numDepths).keys()]).map(v=>v+labelOffset);
	}

	s="<table><tr><th>Depth</th>"
	for(pin in f) {
		s+="<th style='padding:0 5px'><span class='tupin'>Pin</span> "+(parseInt(pin)+1)+"</th>"
	}
	s+="</tr>"
	for(d=0;d<depthLabels.length;d++) {
		s+="<tr><th>"+depthLabels[d]+"</th>"
		for(pin in f) {
			colour=(f[pin][d]==0)?"#FF0000":colourScale(255,255,0,45,255,45,(f[pin][d]-min)/(max-min));
			s+="<td style='background-color:"+colour+";padding:0 5px;'>"+f[pin][d]+"</td>"
		}
		s+="</tr>"
	}
	s+="</table>"
	return s;
}

function colourScale(r1,g1,b1,r2,g2,b2,p) {
	return "rgb("+((r1+(r2-r1)*p))+","+((g1+(g2-g1)*p))+","+((b1+(b2-b1)*p))+")";
}

function codeFromString(str) {
	candidate=str.split(",");
	if(candidate.length<2) {
		candidate=str.split(" ");
		if(candidate.length<2) {
			candidate=str.split("");
		}
	}
	return candidate.map(function(x) {return parseInt(x)-1;});
}
function anglesFromString(str) {
	candidate=str.split(",");
	if(candidate.length<2) {
		candidate=str.split(" ");
	return candidate.map(function(x) {
		x=x.toUpperCase().trim().replace(/\d/,""); 
		if(["C","L","R"].includes(x)) 
			return x; 
			var s=""; 
		if(x.includes("B") || x.substr(0,1)=="C") 
			s+="C"; 
		else if(x.includes("K") || x.substr(0,1)=="L")
			s+="L"; 
		else if(x.includes("Q") || x.substr(0,1)=="R")
			s+="R"; 
		else s+="_"; 
		if(x.includes("D") || x.substr(1,1)=="C") 
			s+="C"; 
		else if(x.includes("M") || x.substr(1,1)=="L") 
			s+="L"; 
		else if(x.includes("S") || x.substr(1,1)=="R") 
			s+="R"; 
		else s+="_"; 
		return s;
	});
	}
}

function drawAngle(a) {
	var sD="";
	var sN="";
	var tmp;
	for(i in a) {
		tmp=a[i].replace("K","L").replace("M","L").replace("B","C").replace("D","C").replace("Q","R").replace("S","R");
		sN+=tmp+" ";
		sD+=tmp.replace(/L/g,"\\").replace(/C/g,"|").replace(/R/g,"/").replace("_"," ")+" ";
	}
	return sD+"\n"+sN;
}
function reduceASpace() {
	if(a_pspace) {
		return a_space.map(p=>[0,1].map(FA=>p.map(x=>x.substr(FA,1)).reduce(function(r,i) {return r=="_"?i:r=="?"?"?":r==i?i:"?";},"_")).join(""));
	} else {
		a=[0,1].map(FA=>a_space.reduce(function(r,i) {return r.map((rx,ri)=>rx=="_"?i[ri].substr(FA,1):i[ri].substr(FA,1)=="_"?rx:rx=="?"?"?":rx==i[ri].substr(FA,1)?i[ri].substr(FA,1):"?");},"_".repeat(numPins).split("")))
		return a[0].map((x,i)=>a.map(y=>y[i]).join(""));
	}
}


function removeRule(ruleNum) {
	rules.splice(ruleNum,1);
	recalcSpace();
}
function printSpace() {
	for(i in space) {
		console.log(space[i].map(function(x) {return x+1;}));
	}
}
function Import(json) {
	dat=JSON.parse(json);
	document.getElementById("lockType").value=dat.lockType;
	document.getElementById("numPins").value=dat.numPins;
	document.getElementById("numDepths").value=dat.numDepths;
	document.getElementById("pinLabels").selectedIndex=dat.labelOffset;
	rules=dat.rules;
}
function cb_tree(cb) {
	base=[];
	cb_tree_helper(base,cb,0);
	return base;
}
function cb_tree_helper(base,cb,depth) {
	//for
}
function medeco_code_card() {
	depth_i=medeco_cb_depths.depths.indexOf(parseInt(medeco_cc_depths.value));
	angle_i=Math.max(medeco_cb_angles.angles.indexOf(medeco_cc_angles.value),medeco_cb_angles.angles_2.indexOf(medeco_cc_angles.value))
	indirect_code=medeco_cb_depths.depth_codes[depth_i]+medeco_cb_angles.angle_codes[angle_i];
	document.getElementById("medeco_cc_out").innerHTML=indirect_code+"<br /><div style=\"font-size: 14pt;font-family:monospace;padding: 139px 149px;color:#282830;text-shadow: #000000 -1.5px 1.5px 0px, #9999AA 1px -1px 2px;width:433px;height:270px;background-size:433px 270px;font-weight:bold;background-image:url('medeco_code_card.png');\"><div style=\"transform: rotate(4deg) scale(1) skew(9deg) translate(0px); display:block;\">"+medeco_cc_blank.value+" "+indirect_code+"</div></div>";
}

function hash(str) {
    var hash = 0;
    if (str.length == 0) {
        return hash;
    }
    for (var i = 0; i < str.length; i++) {
        var char = str.charCodeAt(i);
        hash = ((hash<<5)-hash)+char;
        hash = hash & hash; // Convert to 32bit integer
    }
    return hash;
}


function doc_load() {
	if(decodeURIComponent(window.location.search.substr(1)).length>5) {
		Import(decodeURIComponent(window.location.search.substr(1)));
	}
	recalcSpace();
}


</script>

</head>
<style>
	#spacelist>div,div.rule {
		border:1px solid #888888;
		border-radius:5px;
		margin:3px;
		padding:3px;
		overflow:auto;
	}
	.top-tabpane>div {
		overflow:auto; 
		height: calc(100% - 43px);
	}
	.ruleTab {
		border: 1px solid #DDDDDD;
		border-top: none;
		overflow: auto;
	}
	.ruleForm {
		border: 1px solid #888888;
		border-radius: 10px;
		background-color: #EEEEEE;
		padding: 10px;
		margin: 10px;
	}
	.ruleHelpBtn {
		float: right;
		clear:both;
	}
	body {
		margin: 20px 20px 20px 40px;
	}
</style>
<body onload="doc_load();">
<h3>1. Set basic system information</h3>
 Starting space - <span class='tpin'>pin</span>s: <input class='form-control' style='width:60px;display:inline-block' type='number' min='1' max='20' id='numPins' onchange='recalcSpace()' value='5' />, 
depths: <input class='form-control' style='width:60px;display:inline-block' type='number' min='2' max='20' id='numDepths' onchange='recalcSpace()' value='6' />, numbered <select id='pinLabels'  class='form-control' style='width:auto;display:inline-block' onchange='recalcSpace()'><option>0-based</option><option selected>1-based</option></select>.  
Type of system: 

<select id='lockType' onchange='recalcSpace()'  class='form-control' style='width:auto;display:inline-block'>
	<option value='pin'>Pin Tumbler</option>
	<option value='wafer'>Wafer Tumbler</option>
	<optgroup label="Medeco">
		<option value='medeco'>Medeco Classic</option>
		<option value='medeco2'>Biaxial/m3</option>
	</optgroup>
	<optgroup label="Disc Detainer">
		<option value='disc'>Disc Detainer</option>
		<option value='abloy_exec'>Abloy Exec</option>
		<option value='abloy_protec'>Abloy Protec/Protec2</option>
	</optgroup>
	<option value='multlock'>Mul-T-Lock</option>
	<option value='evva'>Evva MCS</option>
</select>

<!--Decoding: 
<select id='decoding' onchange='recalcSpace()'>
	<option>Top Level Master</option>
	<option>Key for non-mastered system</option>
	<option>Top Level IC control key</option>
	<option>Control Key for Known Lock</option>
</select>-->

<h3>2. See current keyspace report and rules</h3>

<div id='spacelist'>
</div>


<hr>

<h3>3. Add more rules based on information at hand to reduce keyspace</h3>
<div style='margin:10px'>
<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" href="#tabMACS">MACS & Stuff</a></li>
  <li><a data-toggle="tab" href="#tabCK">Known Change Key</a></li>
  <li><a data-toggle="tab" href="#tabShear">Known Shear Lines</a></li>
  <li><a data-toggle="tab" href="#tabPhoto">Photos</a></li>
  <li><a data-toggle="tab" href="#tabImpr">Impressioning</a></li>
  <li><a data-toggle="tab" href="#tabCMK">Construction Keying</a></li>
  <li><a data-toggle="tab" href="#tabIC">IC Master Control Key</a></li>
  <!--li><a data-toggle="tab" href="#tabCodebook">Codebooks</a></li-->
  <li><a data-toggle="tab" href="#tabMedeco">Medeco</a></li>
</ul>
<div class="tab-content">
    <div id="tabMACS" class="ruleTab active tab-pane fade in">
		<div class='ruleForm'>
			MACS: <input type='number' min=1 max=11 id="MACS" value='7'  class='form-control' style='width:auto;display:inline-block' /><button onclick='rules.push({"name":"MACS","MACS":parseInt(document.getElementById("MACS").value)}); recalcSpace()' class='btn btn-primary'>Add Rule <span class="glyphicon glyphicon-hourglass"></span></button>
			<button data-toggle="collapse" class="ruleHelpBtn btn btn-primary btn-sm" data-target="#helpRuleFormMACS">?</button>
			<div id="helpRuleFormMACS" class="collapse ruleHelpTxt">
				Keys cannot be cut with one position very high cut beside one very low cut.  This maximum difference between cuts is the MACS.  <br />
				E.g. if your MACS is 7, then a key code 094123 is a MACS violation because 0 and 9 are too far apart in pins 1 and 2.  074123 is OK.<br />
				<a target='_blank' href='https://youtu.be/suN0IsifTyY?t=358'>See explanation video</a>
			</div>
		</div>
		<div class='ruleForm'>
			<span class='tupin'>Pin</span>-by-<span class='tpin'>pin</span> MACS: <div id="medMACSDiv" style='display:inline-block;'></div>
			<button onclick='s=[];for(i=0;i<numPins-1;i++){s.push(document.getElementById("medMACS"+i).value)};rules.push({"name":"medeco_MACS","MACS":s}); recalcSpace()' class='btn btn-primary'>Add Rule <span class="glyphicon glyphicon-hourglass"></span></button>
			<button data-toggle="collapse" class="ruleHelpBtn btn btn-primary btn-sm" data-target="#helpRuleFormVarMACS">?</button>
			<div id="helpRuleFormVarMACS" class="collapse ruleHelpTxt">
				Some specialty keys have a different MACS between different pin stacks.  E.g. Medeco has a different MACS for fore-aft, fore-fore and aft-aft, and Mul-T-Lock has a MACS between an inner and outer pin stack but no MACS between pin stacks.
			</div>
		</div>
		<hr />
		<div class='ruleForm'>
			<button onclick='rules.push({"name":"retain"});recalcSpace()' class='btn btn-primary'>Add Rule - Key Retaining <span class="glyphicon glyphicon-hourglass"></span></button>
			<button data-toggle="collapse" class="ruleHelpBtn btn btn-primary btn-sm" data-target="#helpRuleFormKeyRetain">?</button>
			<div id="helpRuleFormKeyRetain" class="collapse ruleHelpTxt">
				Sometimes a valid key for a lock cannot be removable from the lock when the key is turned.  This rule ensures this by ensuring that at some point on the key, the depth increases at least once.  E.g. 12345 can be pulled out of the lock, but 12343 cannot.<br />
				<a target='_blank' href='https://youtu.be/suN0IsifTyY?t=857'>See explanation / example video</a>
			</div>
		</div>
		<div class='ruleForm'>
			<div id="fileability" style='display:none;'></div><!--br /-->
			<button onclick='rules.push({"name":"onehigh","within":1});recalcSpace()' class='btn btn-primary'>Add Rule - One Pin High Cut <span class="glyphicon glyphicon-hourglass"></span></button>
			<button data-toggle="collapse" class="ruleHelpBtn btn btn-primary btn-sm" data-target="#helpRuleFormFile">?</button>
			<div id="helpRuleFormFile" class="collapse ruleHelpTxt">
				GMKs are often made to have one pin at the highest depth so that none of the change keys can be filed down into the GMK.
			</div>
		</div>
		<div class='ruleForm'>
			<button onclick='rules.push({"name":"onelow","within":1});recalcSpace()' class='btn btn-primary'>Add Rule - One Pin Low Cut <span class="glyphicon glyphicon-hourglass"></span></button>
			<button data-toggle="collapse" class="ruleHelpBtn btn btn-primary btn-sm" data-target="#helpRuleFormLowCut">?</button>
			<div id="helpRuleFormLowCut" class="collapse ruleHelpTxt">
				GMKs are often made to have one pin at the lowest depth so that none of the change keys can act as a bump key to bring any lock on the system to the master shear lines.
			</div>
		</div>
  </div>
  <div id="tabCMK" class="ruleTab tab-pane fade in">
		<div class='ruleForm'>
			This system used a construction key with a ball bearing in pins <input type='text' id='CMKpins' value="1" class='form-control' style='width:auto;display:inline-block' /> with thickness <input type='number' min=1 max=8 value=4 id="CMKthick" class='form-control' style='width:auto;display:inline-block' />.<br />  
			Using MACS of <input type='number' min=1 max=11 id="CMKMACS" value='7' class='form-control' style='width:auto;display:inline-block' /> for master construction key.
			<button onclick='rules.push({"name":"CMK","depth":parseInt(document.getElementById("CMKthick").value),"pins":document.getElementById("CMKpins").value,"MACS":parseInt(document.getElementById("CMKMACS").value)}); recalcSpace()' class='btn btn-primary'>Add Rule <span class="glyphicon glyphicon-hourglass"></span></button>
			<button data-toggle="collapse" class="ruleHelpBtn btn btn-primary btn-sm" data-target="#helpRuleFormConst">?</button>
			<div id="helpRuleFormConst" class="collapse ruleHelpTxt">
				Construction keyed systems cannot have a GMK cut below a certain depth in construction pinned chambers.<br />
				<a target='_blank' href='https://youtu.be/suN0IsifTyY?t=4712'>See explanation / example video</a>
			</div>
		</div>
  </div>
  <div id="tabImpr" class="ruleTab tab-pane fade in">
		<div class='ruleForm'>
			<span class='tupin'>Pin</span> <input type='number' min=1 max=11 id="imprPin" onchange="if(nextImprTryout) document.getElementById('imprDepth').value=nextImprTryout[this.value-1]+labelOffset;" class='form-control' style='width:auto;display:inline-block' />
			has <select id='imprRel' class='form-control' style='width:auto;display:inline-block'><option value="neq" selected>No shear line at</option><option value="eq">Shear line at</option><option value="lt">No shear line at or above</option></select>
			depth <input type='number' min=1 max=11 id="imprDepth" class='form-control' style='width:auto;display:inline-block' />
			<button onclick='rules.push({"name":"impression","pin":parseInt(document.getElementById("imprPin").value),"rel":["neq","eq","lt"][document.getElementById("imprRel").selectedIndex],"depth":parseInt(document.getElementById("imprDepth").value)}); recalcSpace()' class='btn btn-primary'>Add Rule</button>
			<button data-toggle="collapse" class="ruleHelpBtn btn btn-primary btn-sm" data-target="#helpRuleFormImpression">?</button>
			<div id="helpRuleFormImpression" class="collapse ruleHelpTxt">
				Given the information you have about the lock so far, we can impression it to get more information about where the shear lines are. <br />
				<a target='_blank' href='https://youtu.be/suN0IsifTyY?t=2338'>See explanation / example video</a>
			</div>
		</div>
		<hr>
		<div id='imprTryout'></div>
  </div>
  <div id="tabIC" class="ruleTab tab-pane fade in">
		<div class='ruleForm'>
			This is an interchangeable core system with IC collar on <span class='tpin'>pin</span>s <input type='text' id='ICpins' value="3,4" class='form-control' style='width:auto;display:inline-block' /> with thickness <input type='number' min=1 max=8 value=3 id="ICthick" class='form-control' style='width:auto;display:inline-block' />.<br />  Using MACS of <input type='number' min=1 max=11 id="ICMACS" value='7' class='form-control' style='width:auto;display:inline-block' /> for master control key.<br />
			<button onclick='rules.push({"name":"IC","depth":parseInt(document.getElementById("ICthick").value),"pins":document.getElementById("ICpins").value,"MACS":parseInt(document.getElementById("ICMACS").value)}); recalcSpace()' class='btn btn-primary'>Add Rule <span class="glyphicon glyphicon-hourglass"></span></button>
			<button data-toggle="collapse" class="ruleHelpBtn btn btn-primary btn-sm" data-target="#helpRuleFormIC">?</button>
			<div id="helpRuleFormIC" class="collapse ruleHelpTxt">
				For certain IC systems, locksmiths are lazy and impose GMK limitations that force a low cut in pins with the IC collar.<br />
				<a target='_blank' href='https://youtu.be/suN0IsifTyY?t=4918'>See explanation / example video</a>
			</div>
		</div>
  </div>
  <div id="tabCK" class="ruleTab tab-pane fade in">
		<div class='ruleForm'>
			A key with code <input type='text' id="CKcode" value='' class='form-control' style='width:auto;display:inline-block' /> is known to be a change key.<br />
			<label><input type='checkbox' id="CKfile" value='' /> System prevents any change key from being filed to a master</label><br />
			<label><input type='checkbox' id="CK2step" value='' /> Two-step system</label><br />
			<label><input type='checkbox' id="CKRC" value='' /> Rotating-constant system</label><br />
			<label><input type='checkbox' id="CKspace" value='' /> Spacers size <input type='number' min=1 max=11 id="CKminSpace" class='form-control' style='width:auto;display:inline-block' /> or thinner are avoided.</label><br />
			<button onclick='rules.push({"name":"CK","code":document.getElementById("CKcode").value,"file":document.getElementById("CKfile").checked,"twostep":document.getElementById("CK2step").checked,"rotateConst":document.getElementById("CKRC").checked,"space":document.getElementById("CKspace").checked,"minSpace":parseInt(document.getElementById("CKminSpace").value),"angle":true,"depth":true}); recalcSpace()' class='btn btn-primary'>Add Rule</button>
			<button data-toggle="collapse" class="ruleHelpBtn btn btn-primary btn-sm" data-target="#helpRuleFormChange">?</button>
			<div id="helpRuleFormChange" class="collapse ruleHelpTxt">
				A known low-level change key often rules out a GMK sharing any of the same depths with it.
				<ul>
					<li>If the GMK much be higher than this change key in at least one position, check "System prevents any change key from being filed to a master".  Note that this increases compute time significantly. </li>
					<li>If the mastered system is a rotating constant system, check "rotating constant".  Note that you must know (or vary and trial-and-error) how many pins stacks are constant. </li>
				</ul>
				<a target='_blank' href='https://youtu.be/suN0IsifTyY?t=4153'>See explanation / example video</a>
			</div>
		</div>
  </div>
  <div id="tabShear" class="ruleTab tab-pane fade in">
		<div class='ruleForm'>
			One lock in the system has shear lines (blank for unknown):<div id="shearDiv"></div>
			<label><input type='checkbox' id="shearNonMK" value='' /> If a GMK is made at some shear lines, it must be possible for the other shear lines to form a MACS compliant key</label><br />
			<button onclick='s=[];for(i=0;i<numPins;i++){s.push(document.getElementById("shear"+i).value)};rules.push({"name":"shear","shears":s,"nonMK":document.getElementById("shearNonMK").checked}); recalcSpace()' class='btn btn-primary'>Add Rule</button>
			<button data-toggle="collapse" class="ruleHelpBtn btn btn-primary btn-sm" data-target="#helpRuleFormShears">?</button>
			<div id="helpRuleFormShears" class="collapse ruleHelpTxt">
				If you know the shear lines in one lock on the system, usually by disassembly, enter it here.  Enter shear lines with a comma-separated list.  Leave a pin blank if you don't have any information about that pin stack.<br />
				<a target='_blank' href='https://youtu.be/suN0IsifTyY?t=4004'>See explanation / example video</a>
			</div>
		</div>
  </div>
  <!--div id="tabCodebook" class="ruleTab tab-pane fade in">
		<div class='ruleForm'>
			Key must be in codebook:<select>
				<option>FORD ####X Fleet</option>
				<option>NATIONAL C###A Cabinet</option>
			</select><br />
			<button onclick='rules.push({"name":"codebook","book":"FORD ####X Fleet"}); recalcSpace()' class='btn btn-primary'>Add Rule</button>
			<button data-toggle="collapse" class="ruleHelpBtn btn btn-primary btn-sm" data-target="#helpRuleFormShears">?</button>
			<div id="helpRuleFormShears" class="collapse ruleHelpTxt">
				Lorem ipsum dolor text....
			</div>
		</div>
  </div-->
  <div id="tabMedeco" class="ruleTab tab-pane fade in">
		<!--div class='ruleForm'>
			<This system's depths follow Medeco codebooks as of <select class='form-control' style='width:auto;display:inline-block'><option>1970</option></select>
			<button onclick='rules.push({"name":"medeco_cb_depth"}); recalcSpace()' class='btn btn-primary'>Add Rule <span class="glyphicon glyphicon-hourglass"></span></button><br />
			This system's angles follow Medeco biaxial codebooks as of <select class='form-control' style='width:auto;display:inline-block'><option>1985</option></select>
			<button onclick='rules.push({"name":"medeco_cb_angle","angle":true}); recalcSpace()' class='btn btn-primary'>Add Rule <span class="glyphicon glyphicon-hourglass"></span><span class="glyphicon glyphicon-paperclip"></span></button>
			<button data-toggle="collapse" class="ruleHelpBtn btn btn-primary btn-sm" data-target="#helpRuleFormMedecoCode">?</button>
			<div id="helpRuleFormMedecoCode" class="collapse ruleHelpTxt">
				Lorem ipsum dolor text....
			</div>
		</div-->
		<div class='ruleForm'>
			Fore/aft for one lock is known: <div id="FADiv" style='display:inline-block;'></div>
			<button onclick='s=[];for(i=0;i<numPins;i++){s.push(document.getElementById("FA"+i).value)};rules.push({"name":"medeco_FA","angle":true,"FAs":s}); recalcSpace()' class='btn btn-primary'>Add Rule <span class="glyphicon glyphicon-paperclip"></span></button>
			<button data-toggle="collapse" class="ruleHelpBtn btn btn-primary btn-sm" data-target="#helpRuleFormMedecoFA">?</button>
			<div id="helpRuleFormMedecoFA" class="collapse ruleHelpTxt">
				If you have decoded the lock to determine which pins are fore and aft, enter that information here.<br />
				<a target='_blank' href='https://youtu.be/suN0IsifTyY?t=5856'>See explanation / example video</a>
			</div>
		</div>
		<div class='ruleForm'>
			Bump key <select id="medBump" class='form-control' style='width:auto;display:inline-block'><option>LCCLlRRlLrrL</option><option>LCCRlRRlLrrL</option><option>RCCLlRRlLrrL</option><option>RCCRlRRlLrrL</option></select> works
			<button onclick='rules.push({"name":"medeco_code","angle":true,"code":document.getElementById("medBump").value}); recalcSpace()' class='btn btn-primary'>Add Rule <span class="glyphicon glyphicon-paperclip"></span></button>
			<button data-toggle="collapse" class="ruleHelpBtn btn btn-primary btn-sm" data-target="#helpRuleFormMedecoSidebar">?</button>
			<div id="helpRuleFormMedecoSidebar" class="collapse ruleHelpTxt">
				If a medeco bump key works in the lock, enter its sidebar code here.  Capital L and R are full 20 degree cuts, lowercase l and r are half-angle, 10 degree cuts halfway between left/right and centre.<br />
				<a target='_blank' href='https://youtu.be/suN0IsifTyY?t=6048'>See explanation / example video</a>
			</div>
		</div>

		<hr />
		<!--Generate code card for angles <select id='medeco_cc_angles' class='form-control' style='width:auto;display:inline-block'></select> and depths <select id='medeco_cc_depths' class='form-control' style='width:auto;display:inline-block'></select> on keyway <input id='medeco_cc_blank' value='1G' class='form-control' style='width:auto;display:inline-block' /><button class='btn' onclick='medeco_code_card()'>Generate</button><div id='medeco_cc_out'> (if angle or depth options don't show up, add more rules to reduce the keyspace)</div>-->
  </div>
  <div id="tabPhoto" class="ruleTab tab-pane fade in">
		<div class='ruleForm'>
			Photograph shows <span class='tpin'>pin</span>s are:<div id="photoPinDiv"></div>
			<!--label><input type='checkbox' id="shearNonMK" value='' />If a GMK is made at some shear lines, it must be possible for the other shear lines to form a MACS compliant key</label-->
			<button onclick='s=[];for(i=0;i<numPins;i++){s.push([parseInt(document.getElementById("udPin"+i+"d").value)-labelOffset,parseInt(document.getElementById("udPin"+i+"u").value)-labelOffset])};rules.push({"name":"photoAbs","ranges":s}); recalcSpace()' class='btn btn-primary'>Add Rule</button>
			<button data-toggle="collapse" class="ruleHelpBtn btn btn-primary btn-sm" data-target="#helpRuleFormPhotoAbs">?</button>
			<div id="helpRuleFormPhotoAbs" class="collapse ruleHelpTxt">
				If you can see some info from a photo but not the exact code, enter what you can tell about which pins are high or low cut:<br />
				<a target='_blank' href='https://youtu.be/suN0IsifTyY?t=1460'>See explanation / example video</a>
			</div>
		</div>
		<div class='ruleForm'>
			Photograph shows delta between <span class='tpin'>pin</span> <input type='number' min=1 max=11 id="photoDeltaP1" onchange="photoDeltaP2.min=parseInt(this.value)+1;" class='form-control' style='width:auto;display:inline-block' /> and <span class='tpin'>pin</span> <input type='number' min=1 max=11 id="photoDeltaP2" onchange="" class='form-control' style='width:auto;display:inline-block' /> is between [<input type='number' min=-11 max=11 id="photoDeltaDd" class='form-control' style='width:auto;display:inline-block' />,<input type='number' min=-11 max=11 id="photoDeltaDu" class='form-control' style='width:auto;display:inline-block' />].
			<button onclick='rules.push({"name":"photoDelt","pin1":parseInt(document.getElementById("photoDeltaP1").value)-1,"pin2":parseInt(document.getElementById("photoDeltaP2").value)-1,"range":[parseInt(document.getElementById("photoDeltaDd").value),parseInt(document.getElementById("photoDeltaDu").value)]}); recalcSpace()' class='btn btn-primary'>Add Rule <span class="glyphicon glyphicon-hourglass"></span></button>
			<button data-toggle="collapse" class="ruleHelpBtn btn btn-primary btn-sm" data-target="#helpRuleFormPhotoDelta">?</button>
			<div id="helpRuleFormPhotoDelta" class="collapse ruleHelpTxt">
				Sometimes from a photo you can't tell the absolute depths, but you can see that some pins are higher than others, or some pins are the same.  Interval notation is used, so:
				<ul>
					<li>[0,0] is "same depth"</li>
					<li>[0,1] is "same or shallower by exactly 1"</li>
					<li>[1,1] is "shallower by exactly one"</li>
					<li>[1,&infin;] is "shallower by any amount" (note that any number greater than the number of depths available is equivalent to infinity here)</li>
					<li>[-1,1] is "different by no more than one"</li>
				</ul>, etc.  Note that pins need not be consecutive - if you can see by the warding lines that pin 1 and pin 4 are the same depth, it's valid to enter pin 1 and 4 different by [0,0].
			</div>
		</div>
		<div class='ruleForm'>
			<div id='colouredPinDiv'></div>
			<button onclick='s=[];for(i=0;i<numPins;i++){s.push(document.getElementById("pinColour_"+i).value)};rules.push({"name":"colourPin","colourPinKeySys":document.getElementById("colourPinKeySys").selectedIndex,"colourPinSet":document.getElementById("colourPinSet").selectedIndex,"pinColours":s}); recalcSpace()' class='btn btn-primary'>Add Rule</button>
			<button data-toggle="collapse" class="ruleHelpBtn btn btn-primary btn-sm" data-target="#helpRuleFormColouredPins">?</button>
			<div id="helpRuleFormColouredPins" class="collapse ruleHelpTxt">
				If a colour-coded pinning key was used, you can see the pin colours with an otoscope.  You need to know what the lock type is, and you need to know (or guess) which pinning key was used.<br />
				<a target='_blank' href='https://youtu.be/suN0IsifTyY?t=1946'>See explanation / example video</a>
			</div>
		</div>

  </div>
</div>
</div> <!-- Region 3 -->

<h3>4. Perform Further Analysis</h3>
<button onclick='addAnalysis(exportReport());' class='btn btn-info'>Export System & Rules</button>
<button onclick='addAnalysis(importTask());' class='btn btn-info'>Import a System & Rules</button>
<button onclick='addAnalysis(optimiseBlanksReport());' class='btn btn-info'>Brute Force - Save Blanks</button>
<button onclick='addAnalysis(colouredPinReport());' class='btn btn-info'>Show Coloured Pin Chart</button>
<button onclick='addAnalysis(createTestLockReport());populateTestLockReport();' class='btn btn-info'>Test Key Space in Interactive Lock</button>
<!--button onclick='addAnalysis(createRulesLockReport());populateRulesLockReport();' class='btn btn-info'>Test Keys and Locks on System</button-->
<button onclick='addAnalysis(conditionalEntropyReport());' class='btn btn-info'>Calculate Conditional Entropies</button>
<div id='graph' style='width:100%;height:500px;display:none;'></div>
<div id='analysisHTML' style='width:100%;'></div>

</body>
</html>